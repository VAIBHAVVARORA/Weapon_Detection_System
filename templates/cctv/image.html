{% extends 'base.html' %}

{% block title %}Analyze Image - ArgusVision{% endblock %}

{% block content %}
<div class="row">
    <!-- Upload Section -->
    <div class="col-lg-5 mb-4">
        <div class="glass-card">
            <h2 class="mb-4">Upload Media</h2>
            <form action="" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="mb-4">
                    <label for="id_image" class="form-label">Select Image or Video</label>
                    {{ form.as_p }}
                </div>
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg" id="analyzeBtn">
                        <span class="spinner-border spinner-border-sm d-none" id="analyzeSpinner" role="status"
                            aria-hidden="true"></span>
                        <span id="analyzeText">Analyze Now</span>
                    </button>
                    <!-- Delete Button using a separate form logic or just a link disguised as button -->
                </div>
            </form>

            <script>
                document.querySelector('form[enctype="multipart/form-data"]').addEventListener('submit', function () {
                    const btn = document.getElementById('analyzeBtn');
                    const spinner = document.getElementById('analyzeSpinner');
                    const text = document.getElementById('analyzeText');

                    btn.disabled = true;
                    spinner.classList.remove('d-none');
                    text.textContent = 'Processing...';
                });
            </script>

            <form action="{% url 'delete_image' %}" method="post" class="mt-3">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-danger w-100">Clear All History</button>
            </form>
        </div>
    </div>

    <!-- Results Section -->
    <div class="col-lg-7">
        <div class="glass-card">
            <h3 class="mb-4">Analysis Results</h3>
            {% if images %}
            <div class="row g-3">
                {% for i in images %}
                <div class="col-md-6">
                    <div class="card bg-transparent border-0">
                        {% if i.processed_image %}
                        <div class="position-relative">
                            <img src="{{ i.processed_image.url }}" class="img-fluid rounded border border-secondary"
                                alt="Processed Result">
                            <div
                                class="position-absolute bottom-0 start-0 w-100 bg-dark bg-opacity-75 text-white p-1 text-center small rounded-bottom">
                                Processed: <span class="fw-bold text-info">{{ i.prediction|default:"" }}</span>
                            </div>
                        </div>
                        {% elif i.image %}
                        <div class="position-relative">
                            <img src="{{ i.image.url }}" class="img-fluid rounded border border-secondary"
                                alt="Original Upload">
                            <div
                                class="position-absolute bottom-0 start-0 w-100 bg-secondary bg-opacity-75 text-white p-1 text-center small rounded-bottom">
                                Original (Waiting)
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5 text-secondary">
                <p class="mb-0">No images processed yet. Upload one to start.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}